(function(){
    'use strict';

    angular.module('vatbook.services')
    .factory('AuthApi', ['$resource', function($resource){
        function add_auth_header(data, headersGetter){
            // as per HTTP authentication spec [1], credentials must
            // encoded in base64. Lets use window.btoa [2]
            var headers = headersGetter();
            headers['Authorization'] = ( 'Basic ' + btoa(data.username +
                                                       ':' + data.password));
        }
        // defining the endpoints. Note we scape url trailing dashes: Angular
        // strips unescaped trailing slashes. Problem as Django redirects urls
        // not ending in slashes to url that ends in slash for SEO reasons, unless
        // we tell Django not to [3]. This is a problem as the POST data cannot be
        // sent with the redirect. So we want Angular to not strip slashes.
        return {
            auth: $resource('/api/v1/auth\\/', {}, {
                login: {
                    method: 'POST',
                    transformRequest: add_auth_header
                },
                logout: {
                    method: 'DELETE'
                }
            }),
            users: $resource('/api/v1/users\\/', {}, {
                create: {
                    method: 'POST'
                }
            })
        };
    }]);
}());
// [1] https://tools.ietf.org/html/rfc2617
// [2] https://developer.mozilla.org/en-US/docs/Web/API/Window.btoa
// [3] https://docs.djangoproject.com/en/dev/ref/settings/#append-slash
