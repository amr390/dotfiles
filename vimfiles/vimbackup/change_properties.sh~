#!/bin/bash

#  @author: Tom Verachtert
#  @date: 20140109
#  
#  This script is used by jenkins to set the system configurations
#  It uses the default svn configuration files and only changes the machine of system specific settings.
#  
#  params:
#	$1 			settings file with alle jenkins settings
#	[$2]		(optional parameter) hostname of the master nodig if current node is slave node. 
#

source $1 2&>1 /dev/null

echo "Configuring the properties files"

####################
#SETUP DB PROPERTIES 
# ** CSF_DATASOURCE **
####################
PROP_FILE="props/datasource.config"
TMP_PROP_FILE=$PROP_FILE.temp
CMD_DB1="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/liquibase.contexts=.*/liquibase.contexts=\""$DB_CONTEXTS\""/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_DB2="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/HOSTNAME1/"$DB_HOST"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_DB3="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/USER1/"$DB_USER"_app/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_DB4="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/PWD1/"$DB_PWD"_app/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_DB5="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/SID1/"$DB_SERVICE"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"

ssh felix@$FELIX_SERVER $CMD_DB1
ssh felix@$FELIX_SERVER $CMD_DB2
ssh felix@$FELIX_SERVER $CMD_DB3
ssh felix@$FELIX_SERVER $CMD_DB4
ssh felix@$FELIX_SERVER $CMD_DB5

####################
#SETUP DB 2 PROPERTIES 
# ** STYX_DATASOURCE **
####################
PROP_FILE="props/datasource.config"
TMP_PROP_FILE=$PROP_FILE.temp
CMD_DB2="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/HOSTNAME2/"$DB_HOST"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_DB3="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/USER2/"$DB_USER"_app/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_DB4="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/PWD2/"$DB_PWD"_app/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_DB5="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/SID2/"$DB_SERVICE"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"

ssh felix@$FELIX_SERVER $CMD_DB2
ssh felix@$FELIX_SERVER $CMD_DB3
ssh felix@$FELIX_SERVER $CMD_DB4
ssh felix@$FELIX_SERVER $CMD_DB5

#########
#SET CMIS 
# ** This section can be removed from scripts
#########
PROP_FILE="props/cmis.config"
CMD_CMIS="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/\/Aanslagbiljetten/\/"$DB_USER"\/Aanslagbiljetten/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_CMIS2="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/\/bezwaardossiers/\/"$DB_USER"\/bezwaardossiers/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_CMIS3="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/\/deurwaarderbijlages/\/"$DB_USER"\/deurwaarderbijlages/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"

ssh felix@$FELIX_SERVER $CMD_CMIS
ssh felix@$FELIX_SERVER $CMD_CMIS2
ssh felix@$FELIX_SERVER $CMD_CMIS3

##########
#COPY CMIS
# ** This section can be removed from scripts..
##########
for i in 2 3 4 5
do 
	PROP_FILE2="props/cmis$i.config"
	TMP_PROP_FILE=$PROP_FILE2.temp
	CMD_CMIS4="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/\"cmis\"/\"cmis"$i"\"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE2; rm $TMP_PROP_FILE"
	ssh felix@$FELIX_SERVER $CMD_CMIS4
done

#############
#SET JMSQUEUE
#############
if [ $FELIX_RUNTIME == "/usr2/felix1" ]; then
   JMS=61616
elif [ $FELIX_RUNTIME == "/usr2/felix2" ]; then
   JMS=62626
elif [ $FELIX_RUNTIME == "/usr2/felix3" ]; then
   JMS=63636
fi

PROP_FILE="props/jms.config"
TMP_PROP_FILE=$PROP_FILE.temp
CMD_JMS_PORT="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/61616/"$JMS"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
ssh felix@$FELIX_SERVER $CMD_JMS_PORT

if [ $INSTALL_TYPE == "slave" ] && [ ! "$2" == "" ]; then
	 echo "changing jms.config file"
     CMD_JMS_HOST="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/localhost/$2/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
     ssh felix@$FELIX_SERVER $CMD_JMS_HOST
fi



#################
#SET QUEUE PARAMS
#################


case "$DB_CONTEXTS" in
    *vlabel* )
		echo "Changing queue settings"
		if [ $FELIX_RUNTIME == "/usr2/felix1" ]; then
		   QUEUE_PORT=61616
		elif [ $FELIX_RUNTIME == "/usr2/felix2" ]; then
		   QUEUE_PORT=62626
		elif [ $FELIX_RUNTIME == "/usr2/felix3" ]; then
		   QUEUE_PORT=63636
		fi

		PROP_FILE="props/csf-communication-queue.config"
		TMP_PROP_FILE=$PROP_FILE.temp
		CMD_QUEUE_PORT="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/61616/"$QUEUE_PORT"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
		ssh felix@$FELIX_SERVER $CMD_QUEUE_PORT

		if [ $INSTALL_TYPE == "slave" ] && [ ! "$2" == "" ]; then
			 echo "changing queue host"
			 CMD_QUEUE_HOST="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/localhost/$2/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
			 ssh felix@$FELIX_SERVER $CMD_QUEUE_HOST
		fi
		
		# common-communication config
		PROP_FILE="props/csf-common-communication.config"
		TMP_PROP_FILE=$PROP_FILE.temp
		CMD_JMS_PORT="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/61616/"$JMS"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
		ssh felix@$FELIX_SERVER $CMD_JMS_PORT
		
		if [ $INSTALL_TYPE == "slave" ] && [ ! "$2" == "" ]; then
			 echo "changing queue host"
			 CMD_QUEUE_HOST="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/localhost/$2/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
			 ssh felix@$FELIX_SERVER $CMD_QUEUE_HOST
		fi
	;;
esac

######################
#SET TWS CONFIGURATION 
# ** This section can be removed.
######################

PROP_FILE="props/tws.config"
TMP_PROP_FILE=$PROP_FILE.temp
CMD_TWS="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/ServerName/getstcsf-tivol.vm.cipal.net/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_TWS2="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/ServerPort/31117/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_TWS3="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/UserID/twsuser/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_TWS4="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/Password/ENC(DFR28sXgv7vPoSxFBklfhw\\\=\\\=)/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"

ssh felix@$FELIX_SERVER $CMD_TWS
ssh felix@$FELIX_SERVER $CMD_TWS2
ssh felix@$FELIX_SERVER $CMD_TWS3
ssh felix@$FELIX_SERVER $CMD_TWS4

######################
#SET APPLICATION THEME
######################
if [ $DB_CONTEXTS == "antwerpenData" ]; then
	THEME="antwerpen"
else 
	THEME="vlaams"
fi 

PROP_FILE="props/csf-application.config"
TMP_PROP_FILE=$PROP_FILE.temp
CMD_APP="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/antwerpen/$THEME/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"

ssh felix@$FELIX_SERVER $CMD_APP


##########################
#SET JOBFEEDBACK COMM FILE
##########################
if [ $FELIX_RUNTIME == "/usr2/felix1" ]; then
   PORT=8081
   SECURE_PORT=8481
elif [ $FELIX_RUNTIME == "/usr2/felix2" ]; then
   PORT=8082
   SECURE_PORT=8482
elif [ $FELIX_RUNTIME == "/usr2/felix3" ]; then
   PORT=8083
   SECURE_PORT=8483
fi

PROP_FILE="props/csf-communication-jobfeedback.config"
TMP_PROP_FILE=$PROP_FILE.temp
CMD_COMPORT="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/8888/"$PORT"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
ssh felix@$FELIX_SERVER $CMD_COMPORT

CMD_COMHOST="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/localhost/"$FELIX_SERVER"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
ssh felix@$FELIX_SERVER $CMD_COMHOST


#############
#SET WEB PORT
#############	

if [ $FELIX_RUNTIME == "/usr2/felix1" ]; then
   PORT=8081
   SECURE_PORT=8481
elif [ $FELIX_RUNTIME == "/usr2/felix2" ]; then
   PORT=8082
   SECURE_PORT=8482
elif [ $FELIX_RUNTIME == "/usr2/felix3" ]; then
   PORT=8083
   SECURE_PORT=8483
fi

PROP_FILE="props/org/apache/felix/http.config"
TMP_PROP_FILE=$PROP_FILE.temp
CMD_WEB="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/8081/"$PORT"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"
CMD_WEB2="cd $FELIX_RUNTIME ;cp $PROP_FILE $TMP_PROP_FILE; sed -e 's/8443/"$SECURE_PORT"/g' $PROP_FILE > $TMP_PROP_FILE ; cp $TMP_PROP_FILE $PROP_FILE; rm $TMP_PROP_FILE"

ssh felix@$FELIX_SERVER $CMD_WEB

## only for vlabel we enable https
#if [ $DB_CONTEXTS == "vlabelData" ]; then
	ssh felix@$FELIX_SERVER $CMD_WEB2
#fi


######################
#ENCRYPT PASSWORDS
######################
# if the exncypt script exits then execute
echo "encrypting passwords"
CMD="cd $FELIX_RUNTIME ; if [ -f encrypt_passwords.sh ]; then ./encrypt_passwords.sh; fi"
ssh felix@$FELIX_SERVER $CMD
echo "done"

######################
#SET INSTALLATION TYPE
######################
echo "setting up the correct install type"

CMD=""

if [ $INSTALL_TYPE == "master" ]; then
	case "$DB_CONTEXTS" in
    *vlabel* )
		CMD="cd $FELIX_RUNTIME/conf ; rm config.ini; ln -s config.masterui.vlabel.ini config.ini"
	;;
	*)
		CMD="cd $FELIX_RUNTIME/conf ; rm config.ini; ln -s config.masterui.ini config.ini"
	;;
	esac
elif [ $INSTALL_TYPE == "slave" ]; then
	case "$DB_CONTEXTS" in
    *vlabel* )
		CMD="cd $FELIX_RUNTIME/conf ; rm config.ini; ln -s config.slave.vlabel.ini config.ini"
	;;
	*)
		CMD="cd $FELIX_RUNTIME/conf ; rm config.ini; ln -s config.slave.ini config.ini"
	;;
	esac
else
	case "$DB_CONTEXTS" in
    *vlabel* )
		CMD="cd $FELIX_RUNTIME/conf ; rm config.ini; ln -s config.masterui.ini config.ini"
	;;
	*)
		CMD="cd $FELIX_RUNTIME/conf ; rm config.ini; ln -s config.masterui.ini config.ini"
	;;
	esac
fi

ssh felix@$FELIX_SERVER $CMD

# also verify if all cocon dirs are present
bash jenkins/create_cocon_dirs.sh $1

# change gc type if not set yet
bash jenkins/change_GC_type.sh $1

echo "done"

exit 0
