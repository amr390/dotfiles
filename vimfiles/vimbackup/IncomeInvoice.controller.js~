(function(){
    'use strict';

    angular.module('vatbook.controllers') .controller('IncomeInvoiceController', [
        'IncomeInvoiceApi',
        'ContributorApi',
        'ClientApi',
        'ConceptApi',
        '$location',
        '$routeParams',
        '$scope',
        function (
            incomeInvoiceApi, contributorApi, clientApi, conceptApi,
            $location, $routeParams, $scope) {
                $scope.initialize = function(){
                    // Initial load for contributors
                    contributorApi.list().then(function(data){
                        $scope.contributors = data;
                    });
                    // Initial load for clients
                    clientApi.list().then(function(data){
                        $scope.clients = data;
                    });
                    // Initial load for concepts
                    conceptApi.list().then(function(data){
                        $scope.concepts = data;
                    });

                    //Edit
                    if($routeParams.id != null){
                        incomeInvoiceApi.get($routeParams.id).then(function(data){
                            $scope.invoice = data;
                        });
                    }else{
                        incomeInvoiceApi.list().then(function(data){
                            $scope.invoices = data;
                        });
                    }
                };

                $scope.save = function(){
                    var promise;
                    if($scope.invoice.id){
                        promise = incomeInvoiceApi.update($scope.invoice);
                    }else{
                        promise = incomeInvoiceApi.save($scope.invoice);
                    }

                    promise.then(function(){
                        $location.path("/invoice/income/list");
                    });
                };

                $scope.remove = function(id){
                    incomeInvoiceApi.remove(id).then(function(){
                        $scope.initialize();
                    });
                };

                $scope.edit = function(id){
                    // Request incomeInvoice on load
                    $location.path("/invoice/income/edit/"+id);
                };

                // We watch for incomeInvoices to refresh list view
                $scope.$watch('invoices');

                $scope.$watch('invoice.base_cost + invoice.concept', function(){
                    if ($scope.concepts){
                        var currentConcept = $scope.concepts.filter(function(item){
                            return parseInt(item.id) === parseInt($scope.invoice.concept);
                        });

                        $scope.invoice.vat_cost = $scope.invoice.base_cost *
                            (currentConcept[0].vat_type/100);
                        $scope.invoice.tax_cost = $scope.invoice.base_cost *
                            (currentConcept[0].tax_type/100);
                        $scope.invoice.total_cost = parseInt($scope.invoice.base_cost) +
                            $scope.invoice.vat_cost - $scope.invoice.tax_cost;
                    }
                });

                $scope.initialize();
            }]);
}());
