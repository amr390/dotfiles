(function(){
    'use strict';

    angular.module('vatbook.controllers')
    .controller('AuthController', ['$rootScope', '$scope', 'AuthApi', function($rootScope, $scope, AuthApi){
        // Angular does not detect auto-fill or auto-complete. If the browser
        // autofills "username", Angular will be unaware of this and think the
        // $scope.username is blank. To workaround this we use the autofill-event
        // polyfill [4][5]
        //$('#id_auth_form input').checkAndTriggerAutoFillEvent();

        $scope.getCredentials = function(){
            return {username: $scope.username, password: $scope.password};
        };

        $scope.login = function(){
            AuthApi.auth.login($scope.getCredentials())
            .$promise
            .then(function(data){
                // on good username and password
                $scope.user = data.username;
                $rootScope.user = data.username;
            })
            .catch(function(data){
                // on incorrect username and password
                alert (data.data.detail);
            });
        };

        $scope.logout = function(){
            AuthApi.auth.logout(function(){
                $scope.user = undefined;
            });
        };

        $scope.register = function($event){
            // prevent login form from firing
            $event.preventDefault();
            // create user and inmediatly login on success
            AuthApi.users.create($scope.getCredentials())
            .$promise
            .then($scope.login)
            .catch(function(data){
                alert(data.data.username);
            });
        };

    }]);


}());
// [4] https://github.com/tbosch/autofill-event
// [5] http://remysharp.com/2010/10/08/what-is-a-polyfill/
